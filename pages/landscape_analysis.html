
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>cryoDRGN Conformational Landscape Analysis &#8212; CryoDRGN 1.1.1 documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Dealing with large datasets" href="large_datasets.html" />
    <link rel="prev" title="cryoDRGN EMPIAR-10076 tutorial" href="empiar_tutorial.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">CryoDRGN 1.1.1 documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contents:
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   ‚ùÑÔ∏èüêâ cryoDRGN Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="installation.html">
   cryoDRGN Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="empiar_tutorial.html">
   cryoDRGN EMPIAR-10076 tutorial
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   cryoDRGN Conformational Landscape Analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="large_datasets.html">
   Dealing with large datasets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="faq.html">
   FAQ / Troubleshooting
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/pages/landscape_analysis.md.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#quickstart">
   1. Quickstart
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#outputs-at-a-glance">
     Outputs at a glance
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#assigning-3d-conformational-states-classes">
   2. Assigning 3D conformational states (‚Äùclasses‚Äù)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#outputs">
     Outputs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optional-change-the-number-of-clusters-with-m">
     Optional: Change the number of clusters with -M:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optional-change-agglomerative-clustering-linkage-with-linkage">
     Optional: Change agglomerative clustering linkage with ‚Äîlinkage:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optional-remove-junk-clusters-volumes">
     Optional: Remove junk clusters/volumes
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#masking-optional">
   3. Masking (optional)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualizing-conformational-landscapes">
   4. Visualizing conformational landscapes
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#output">
     Output
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualizing-the-full-conformational-landscape">
   5. Visualizing the full conformational landscape
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>cryoDRGN Conformational Landscape Analysis</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#quickstart">
   1. Quickstart
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#outputs-at-a-glance">
     Outputs at a glance
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#assigning-3d-conformational-states-classes">
   2. Assigning 3D conformational states (‚Äùclasses‚Äù)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#outputs">
     Outputs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optional-change-the-number-of-clusters-with-m">
     Optional: Change the number of clusters with -M:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optional-change-agglomerative-clustering-linkage-with-linkage">
     Optional: Change agglomerative clustering linkage with ‚Äîlinkage:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optional-remove-junk-clusters-volumes">
     Optional: Remove junk clusters/volumes
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#masking-optional">
   3. Masking (optional)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualizing-conformational-landscapes">
   4. Visualizing conformational landscapes
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#output">
     Output
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualizing-the-full-conformational-landscape">
   5. Visualizing the full conformational landscape
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section id="cryodrgn-conformational-landscape-analysis">
<h1>cryoDRGN Conformational Landscape Analysis<a class="headerlink" href="#cryodrgn-conformational-landscape-analysis" title="Permalink to this headline">#</a></h1>
<p>CryoDRGN is a machine learning system for heterogenous cryo-EM reconstruction. In cryoDRGN‚Äôs framework of <em>generative modeling</em>, once a model is trained, an arbitrary number of volumes may be reconstructed, thus tools are needed to comprehensively explore the reconstructed distribution. This page describes a new ‚Äúlandscape analysis‚Äù tool for comprehensive and quantitative analysis of a trained cryodrgn model, including <strong>1) assigning discrete conformational states (and providing their particle lists for refinement)</strong> and <strong>2) visualizing continuous conformational landscapes</strong>. This tool also allows the user to focus their analysis on specific regions of interest by providing custom masks.</p>
<p>Landscape analysis is implemented in the executables, <code class="docutils literal notranslate"><span class="pre">cryodrgn</span> <span class="pre">analyze_landscape</span></code> and <code class="docutils literal notranslate"><span class="pre">cryodrgn</span> <span class="pre">analyze_landscape_full</span></code>  available in version 1.0+ of the cryoDRGN <a class="reference external" href="https://github.com/zhonge/cryodrgn">software</a>. The analysis pipeline is fully automated, though there are many command line arguments that can be experimented with, and we provide a jupyter notebook for interactive visualization.</p>
<p>A description of the method is found in <a class="reference external" href="https://people.csail.mit.edu/zhonge/zhong-phd-csb-2022.pdf">Chapter 6 of Ellen Zhong‚Äôs thesis</a>.</p>
<p><img alt="Overview of the cryodrgn landscape_analysis pipeline." src="../_images/landscape_analysis_overview.png" /></p>
<p><em>Overview of the cryodrgn landscape_analysis pipeline. We show the general schematic (top) and its application to a dataset of the ClpXP protease from <a class="reference external" href="https://elifesciences.org/articles/61496">Fei et al 2020</a> (bottom).</em></p>
<section id="quickstart">
<h2>1. Quickstart<a class="headerlink" href="#quickstart" title="Permalink to this headline">#</a></h2>
<p>Example usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(cryodrgn) $ cryodrgn analyze_landscape [workdir] [epoch]

# for example:
(cryodrgn) $ cryodrgn analyze_landscape /path/to/cryodrgn/output/directory 24 # assuming 25 epochs of training (0-indexed)

# Use the flag -h to see all settings and their defaults:
(cryodrgn) $ cryodrgn analyze_landscape -h
</pre></div>
</div>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">(cryodrgn)</span> <span class="pre">$</span> <span class="pre">cryodrgn</span> <span class="pre">analyze_landscape</span> <span class="pre">-h</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(cryodrgn) $ cryodrgn analyze_landscape -h
usage: analyze_landscape.py [-h] [--device DEVICE] [-o OUTDIR] [--skip-vol]
                            [--skip-umap] [--skip-mask] [--vol-ind VOL_IND]
                            [--linkage LINKAGE] [-M M] [--pc-dim PC_DIM]
                            [--plot-dim PLOT_DIM] [--Apix APIX] [--flip]
                            [-d DOWNSAMPLE] [--ksample KSAMPLE]
                            [--thresh THRESH] [--dilate DILATE]
                            workdir epoch

Pipeline to analyze cryoDRGN volume distribution

positional arguments:
workdir               Directory with cryoDRGN results
epoch                 Epoch number N to analyze (0-based indexing, corresponding to z.N.pkl, weights.N.pkl)

optional arguments:
-h, --help            show this help message and exit
--device DEVICE       Optionally specify CUDA device
-o OUTDIR, --outdir OUTDIR
                      Output directory for landscape analysis results (default: [workdir]/landscape.[epoch])
--skip-umap           Skip running UMAP
--vol-ind VOL_IND     Index .pkl for filtering volumes

Extra arguments for volume generation:
-N SKETCH_SIZE, --sketch-size SKETCH_SIZE
                      Number of volumes to generate for analysis (default: 1000)
--Apix APIX           Pixel size to add to .mrc header (default: 1 A/pix)
--flip                Flip handedness of output volume
-d DOWNSAMPLE, --downsample DOWNSAMPLE
                      Downsample volumes to this box size (pixels) (default: 128)
--skip-vol            Skip generation of volumes
--vol-start-index VOL_START_INDEX
                      Default value of start index for volume generation (default: 0)

Extra arguments for mask generation:
--thresh THRESH       Density value to threshold for masking (default: half of max density value)
--dilate DILATE       Dilate initial mask by this amount (default: 5 pixels)
--mask MRC            Path to a custom mask. Must be same box size as generated volumes.

Extra arguments for clustering:
--linkage LINKAGE     Linkage for agglomerative clustering (e.g. average, ward) (default: average)
-M M                  Number of clusters (default: 10)

Extra arguments for landscape visualization:
--pc-dim PC_DIM       PCA dimensionality reduction (default: 20)
--plot-dim PLOT_DIM   Number of dimensions to plot (default: 5)
</pre></div>
</div>
</li>
</ul>
<p>By default, the script will:</p>
<ol class="arabic simple">
<li><p><strong>Generate 1000 volumes</strong> at a box size of 128^3</p></li>
<li><p><strong>Perform PCA</strong>  on the volumes to map conformational coordinates. The goal is for the volume PCA coordinates to provide a more visually interpretable representation of the dataset than the VAE latent space.</p></li>
<li><p><strong>Cluster the volumes</strong> and provide summary volumes and the constituent particles for each cluster.</p></li>
</ol>
<p>By default, all outputs will be located in a subdirectory <code class="docutils literal notranslate"><span class="pre">[workdir]/landscape.[epoch]</span></code>.</p>
<p>The expected runtime is ~30 min (1 GPU) which is mostly spent on volume generation); Rerunning the tool without volume generation (<code class="docutils literal notranslate"><span class="pre">--skip-vol</span></code>) should take less than 5 min (no GPU)</p>
<section id="outputs-at-a-glance">
<h3>Outputs at a glance<a class="headerlink" href="#outputs-at-a-glance" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">kmeans1000</span></code>: 1000 generated volumes</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">clustering_L2_average_10</span></code>: clustering of the sketched volume ensemble as summary conformational states with:</p>
<ul>
<li><p>The mean and std volume for each cluster</p></li>
<li><p>The constituent particles for each cluster (.pkl), which can be converted to a .star file</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">pcs</span></code>: 5 eigenvolume trajectories of the sketched volume ensemble as summary reaction coordinates</p></li>
</ul>
</section>
</section>
<section id="assigning-3d-conformational-states-classes">
<h2>2. Assigning 3D conformational states (‚Äùclasses‚Äù)<a class="headerlink" href="#assigning-3d-conformational-states-classes" title="Permalink to this headline">#</a></h2>
<p>Once 1000 volumes are generated, they are clustered to summarize the major conformational states of the reconstructed ensemble. This clustering approach mirrors some of the assumptions in 3D classification (i.e. that particles fall in 1 of K discrete classes). The resulting clusters can be interpreted as the main conformational states, and this tool provided the constituent particles as a .star file can be exported to other tools for further refinement.</p>
<p>We use agglomerative clustering, a bottom-up clustering algorithm that does not impose any geometric priors on the shape or size of the clusters. Through testing on several datasets, we find that this is effective at <strong>identifying rare states.</strong> We also use a <strong>mask</strong> around the particle to reduce the effect of noise in the background of the density map. A mask may also be manually provided to focus on a specific region (see Section 3).</p>
<p>There are many hyperparameters of the clustering algorithm. As a best practice, one should experiment with the number of clusters (<code class="docutils literal notranslate"><span class="pre">-M</span></code>) and the agglomerative clustering affinity type (e.g. <code class="docutils literal notranslate"><span class="pre">--linkage</span> <span class="pre">average</span></code> or <code class="docutils literal notranslate"><span class="pre">--linkage</span> <span class="pre">ward</span></code>).  See the below subsections for some examples of changing these parameters.</p>
<section id="outputs">
<h3>Outputs<a class="headerlink" href="#outputs" title="Permalink to this headline">#</a></h3>
<p>The outputs of clustering will be located in a subdirectory <code class="docutils literal notranslate"><span class="pre">clustering_L2_average_10</span></code></p>
<ul class="simple">
<li><p>Each cluster is described by:</p>
<ul>
<li><p>A mean volume and standard deviation volume, e.g. 0_mean.mrc, 0_std.mrc, 1_mean.mrc, 1_std.mrc, ‚Ä¶</p></li>
<li><p>A numbered subdirectory (<code class="docutils literal notranslate"><span class="pre">0</span></code>, <code class="docutils literal notranslate"><span class="pre">1</span></code>, <code class="docutils literal notranslate"><span class="pre">2</span></code>, etc.) containing the volumes in each cluster</p></li>
<li><p>A list of the underlying particles (as an index <code class="docutils literal notranslate"><span class="pre">.pkl</span></code> file) that may be converted to a .star file with <code class="docutils literal notranslate"><span class="pre">cryodrgn_utils</span> <span class="pre">write_star</span></code></p></li>
</ul>
</li>
<li><p>Visualization of the 1000 volumes colored by cluster label in the VAE latent space (umap.png, umap_annotated.png) and in the volume PCA space (vol_embeddings_1000*png).</p></li>
<li><p>Volume and particle counts for each cluster (volume_counts.png, particle_counts.png)</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>cryodrgn<span class="o">)</span> $ ls clustering_L2_average_10/
<span class="m">0</span>                   2_std.mrc           5_particle_ind.pkl  8_mean.mrc           vol_embeddings_1000_annotated_1_2.png
0_mean.mrc          <span class="m">3</span>                   5_std.mrc           8_particle_ind.pkl   vol_embeddings_1000_annotated_2_3.png
0_particle_ind.pkl  3_mean.mrc          <span class="m">6</span>                   8_std.mrc            vol_embeddings_1000_annotated_3_4.png
0_std.mrc           3_particle_ind.pkl  6_mean.mrc          <span class="m">9</span>                    vol_embeddings_1000_annotated_4_5.png
<span class="m">1</span>                   3_std.mrc           6_particle_ind.pkl  9_mean.mrc           vol_embeddings_1000_clusters_1_2.png
1_mean.mrc          <span class="m">4</span>                   6_std.mrc           9_particle_ind.pkl   vol_embeddings_1000_clusters_2_3.png
1_particle_ind.pkl  4_mean.mrc          <span class="m">7</span>                   9_std.mrc            vol_embeddings_1000_clusters_3_4.png
1_std.mrc           4_particle_ind.pkl  7_mean.mrc          cluster_labels.pkl   vol_embeddings_1000_clusters_4_5.png
<span class="m">2</span>                   4_std.mrc           7_particle_ind.pkl  particle_counts.png  volume_counts.png
2_mean.mrc          <span class="m">5</span>                   7_std.mrc           umap_annotated.png
2_particle_ind.pkl  5_mean.mrc          <span class="m">8</span>                   umap.png
</pre></div>
</div>
</section>
<section id="optional-change-the-number-of-clusters-with-m">
<h3>Optional: Change the number of clusters with -M:<a class="headerlink" href="#optional-change-the-number-of-clusters-with-m" title="Permalink to this headline">#</a></h3>
<p>The default number of clusters is 10. If your dataset is very heterogeneous or if you want a finer resolution, you can increase the number of clusters with the <code class="docutils literal notranslate"><span class="pre">-M</span></code> flag. Changing <code class="docutils literal notranslate"><span class="pre">M</span></code> corresponds to changing the cut point in the dendrogram of agglomerative clustering. Clustering can be repeated by re-running <code class="docutils literal notranslate"><span class="pre">cryodrgn</span> <span class="pre">analyze_landscape</span></code> and using the <code class="docutils literal notranslate"><span class="pre">--skip-vol</span></code> flag to skip volume generation, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(cryodgn) $ cryodrgn analyze_landscape [workdir] [epoch] --skip-vol -M 20 # use --skip-vol to skip regenerating 1000 volumes

# Results will be found in a new subdirectory, clustering_L2_average_[M]
</pre></div>
</div>
<p><img alt="Left: Clustering results with M=10; Right: Clustering results with M=20" src="../_images/landscape_analysis_clustering_results1.png" /></p>
<p><em>Left: Clustering results with M=10; Right: Clustering results with M=20</em></p>
<p>The updated clustering results will be a new subdirectory, <code class="docutils literal notranslate"><span class="pre">clustering_L2_average_[M]</span></code>.</p>
</section>
<section id="optional-change-agglomerative-clustering-linkage-with-linkage">
<h3>Optional: Change agglomerative clustering linkage with ‚Äîlinkage:<a class="headerlink" href="#optional-change-agglomerative-clustering-linkage-with-linkage" title="Permalink to this headline">#</a></h3>
<p>The linkage type affects how volumes are merged in the agglomerative clustering algorithm. The default setting is <code class="docutils literal notranslate"><span class="pre">--linkage</span> <span class="pre">average</span></code>, which, we have found to be sensitive to outliers (e.g. junk/artifacts or rare states of interest). For more evenly populated clusters (e.g. discretizing a structural continuum), try <code class="docutils literal notranslate"><span class="pre">--linkage</span> <span class="pre">ward</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(cryodgn) $ cryodrgn analyze_landscape [workdir] [epoch] --skip-vol --linkage ward # use --skip-vol to skip regenerating 1000 volumes
</pre></div>
</div>
<p><img alt="Left: Clustering results with average linkage (M=10); Right: Clustering results with ward linkage (M=10)" src="../_images/landscape_analysis_clustering_results2.png" /></p>
<p>Left: Clustering results with average linkage (M=10); Right: Clustering results with ward linkage (M=10)</p>
<p>Rerunning landscape analysis with <code class="docutils literal notranslate"><span class="pre">--linkage</span> <span class="pre">ward</span></code> will produce a new subdirectory, <code class="docutils literal notranslate"><span class="pre">clustering_L2_ward_10</span></code>.</p>
</section>
<section id="optional-remove-junk-clusters-volumes">
<h3>Optional: Remove junk clusters/volumes<a class="headerlink" href="#optional-remove-junk-clusters-volumes" title="Permalink to this headline">#</a></h3>
<p>Some datasets will contain ‚Äújunk‚Äù volumes that can interfere with clustering/PCA analysis. These volumes can be selected and removed with the utility <code class="docutils literal notranslate"><span class="pre">cryodrgn_utils</span> <span class="pre">select_clusters</span></code>:</p>
<p><img alt="Left: Clustering results with default settings." src="../_images/landscape_analysis_clustering_results3.png" /></p>
<p><em>Left: Clustering results with default settings. Manual inspection of the cluster means revealed broken/junk volumes for clusters 3,5,6,7,8. Right: Repeating cryodrgn analyze_landscape after removing the 9 junk volumes from the analysis.</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># e.g. keep the volumes from clusters 0, 1, 2, 4, 9
(cryodrgn) $ cryodrgn_utils select_clusters clustering_L2_average_10/cluster_labels.pkl --sel 0 1 2 4 9 -o vol_keep.pkl

# rerun cryodrgn analyze_landscape with --vol-ind
(cryodrgn) $ cryodrgn analyze_landscape [workdir] [epoch] --skip-vol --skip-mask --vol-ind vol_keep.pkl
</pre></div>
</div>
<p>Note: rerunning with <code class="docutils literal notranslate"><span class="pre">‚Äî-vol-ind</span></code> will change the volume PCA results since volumes have now been removed from the analysis.</p>
</section>
</section>
<section id="masking-optional">
<h2>3. Masking (optional)<a class="headerlink" href="#masking-optional" title="Permalink to this headline">#</a></h2>
<p>This tool applies a mask on all 1000 volumes before PCA/clustering analysis. The default mask is generated by thresholding all 1000 generated volumes at half of their max density values and then combining all masks (by their union). The masking settings may be adjusted with the <code class="docutils literal notranslate"><span class="pre">--thresh</span></code> and <code class="docutils literal notranslate"><span class="pre">--dilate</span></code> arguments if this automated mask generation leaves in undesired regions (e.g. extra background) or leaves out heterogeneous regions of the particle. To check the mask, see the <code class="docutils literal notranslate"><span class="pre">mask.mrc</span></code> and <code class="docutils literal notranslate"><span class="pre">mask_slices.png</span></code> file in the output directory.</p>
<p><img alt="A user-defined mask around the heterogeneous region of the complex" src="../_images/landscape_analysis_user_defined_mask.png" /></p>
<p><em>A user-defined mask around the heterogeneous region of the complex</em></p>
<p>Alternatively, a custom mask can be provided with the flag <code class="docutils literal notranslate"><span class="pre">--mask</span></code>. Note, the mask will be converted to a <em>binary mask</em>, where any nonzero voxel will be included in the analysis:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># rerun cryodrgn analyze_landscape with --skip-mask
(cryodrgn) $ cryodrgn analyze_lanscape [workdir] [epoch] --skip-vol --mask /path/to/your/mask/eg/job008.mrc
</pre></div>
</div>
</section>
<section id="visualizing-conformational-landscapes">
<h2>4. Visualizing conformational landscapes<a class="headerlink" href="#visualizing-conformational-landscapes" title="Permalink to this headline">#</a></h2>
<p>Taking inspiration from <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0092867418300473">previous work</a>, we apply principal component analysis (PCA) on the set of cryoDRGN volumes to map reaction coordinates and visualize a conformational landscape that is more interpretable than the cryoDRGN latent variable representation.</p>
<hr class="docutils" />
<section id="output">
<h3>Output<a class="headerlink" href="#output" title="Permalink to this headline">#</a></h3>
<p>The output of <code class="docutils literal notranslate"><span class="pre">cryodrgn</span> <span class="pre">analyze_landscape</span></code> will include a directory containing the top 5 principal components (.mrc trajectories showing interpolations along the ‚Äúeigenvolumes‚Äù). These principal component trajectories can be interpreted as reaction coordinates for describing the full ensemble, which can provide a more interpretable visualization of the dataset than the latent variable representation.</p>
<p><img alt="Left: Visualization of the dataset in the cryoDRGN VAE latent space" src="../_images/landscape_analysis_latent_space.png" /></p>
<p><em>Left: Visualization of the dataset in the cryoDRGN VAE latent space, colored points correspond to 1000 sampled volumes colored by their cluster label. Center/right: Visualization of 1000 sampled volumes in their PCA feature space. In this example, PC1, PC2, and PC3 correspond to biologically relevant motions and thus the overall organization of the ensemble is more easily interpretable.</em></p>
</section>
</section>
<section id="visualizing-the-full-conformational-landscape">
<h2>5. Visualizing the full conformational landscape<a class="headerlink" href="#visualizing-the-full-conformational-landscape" title="Permalink to this headline">#</a></h2>
<p>The initial mapping of the volumes is performed on the set of 1000 sketched volumes. A second tool, <code class="docutils literal notranslate"><span class="pre">cryodrgn</span> <span class="pre">analyze_landscape_full</span></code>, maps all particles to the volume PCA space to visualize a conformational landscape for the full dataset.  This tool will take longer to run (~4 hours on 1 GPU for volume generation, 1 min for mapping).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>cryodrgn<span class="o">)</span> $ cryodrgn analyze_landscape_full <span class="o">[</span>workdir<span class="o">]</span> <span class="o">[</span>epoch<span class="o">]</span> &gt; landscape_full.log
</pre></div>
</div>
<p><img alt="Left: Visualization of the 1000 volumes in the volume PCA feature space where each volume is a point." src="../_images/landscape_analysis_feature_space.png" /></p>
<p>Left: Visualization of the 1000 volumes in the volume PCA feature space where each volume is a point. Center: Mapping the entire dataset of ~10^5 volumes to the PCA feature space (grey points). Right: Visualizing the conformational landscape as a heatmap on a logscale (i.e. a free energy landscape)</p>
<p>This command produces a jupyter notebook, <code class="docutils literal notranslate"><span class="pre">cryoDRGN_landscape_viz.ipynb</span></code>, for plotting the inferred conformational landscape.</p>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="empiar_tutorial.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">cryoDRGN EMPIAR-10076 tutorial</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="large_datasets.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Dealing with large datasets</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Ellen Zhong<br/>
  
      &copy; Copyright 2022, Ellen Zhong.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>